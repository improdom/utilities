FROM container.registry.net/ubs/charlesriver/images/dotnet/dotnet-sdk-base:0.1.2.sdk-base-image.4 AS base
WORKDIR /Arisk_Sensitivities

FROM container.registry.net/ubs/charlesriver/images/dotnet/dotnet-sdk-base:0.1.2.sdk-base-image.4 AS build
WORKDIR /app

# Copy project and dependencies
COPY ./PowerBI.Deployment/PowerBI.Deployment.API/nuget.config .
COPY ./PowerBI.Deployment/PowerBI.Deployment.API/UBS_Server_CA_Test_3.crt /usr/share/ca-certificates/
RUN update-ca-certificates

COPY ./PowerBI.Deployment/PowerBI.Deployment.API/*.csproj ./PowerBI.Deployment.API/
RUN dotnet restore ./PowerBI.Deployment.API/PowerBI.Deployment.API.csproj

# Copy the rest of the source code and build
COPY ./PowerBI.Deployment/PowerBI.Deployment.API ./PowerBI.Deployment.API/
RUN dotnet build ./PowerBI.Deployment.API/PowerBI.Deployment.API.csproj -c Release --no-restore

# Clean and publish
RUN dotnet clean ./PowerBI.Deployment/PowerBI.Deployment.API/PowerBI.Deployment.API.csproj
RUN dotnet publish ./PowerBI.Deployment/PowerBI.Deployment.API/PowerBI.Deployment.API.csproj -c Release -o /app/publish /p:UseAppHost=false

FROM base AS final
WORKDIR /app
COPY --from=build /app/publish .
ENTRYPOINT ["/app/PowerBI.Deployment.API"]
