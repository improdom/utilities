SELECT
    $SYSTEM.TMSCHEMA_TABLES.[NAME]  AS TableName,
    $SYSTEM.TMSCHEMA_COLUMNS.[NAME] AS ColumnName,
    SUM(CASE WHEN $SYSTEM.DISCOVER_STORAGE_TABLE_COLUMN_SEGMENTS.[IS_RESIDENT] = 1
             THEN 1 ELSE 0 END)     AS ResidentSegments,
    COUNT(*)                         AS TotalSegments
FROM
    $SYSTEM.DISCOVER_STORAGE_TABLE_COLUMN_SEGMENTS,
    $SYSTEM.DISCOVER_STORAGE_TABLE_COLUMNS,
    $SYSTEM.TMSCHEMA_COLUMNS,
    $SYSTEM.TMSCHEMA_TABLES
WHERE
    $SYSTEM.DISCOVER_STORAGE_TABLE_COLUMN_SEGMENTS.[TABLE_ID] =
        $SYSTEM.DISCOVER_STORAGE_TABLE_COLUMNS.[TABLE_ID]
AND $SYSTEM.DISCOVER_STORAGE_TABLE_COLUMN_SEGMENTS.[COLUMN_ID] =
        $SYSTEM.DISCOVER_STORAGE_TABLE_COLUMNS.[COLUMN_ID]
AND $SYSTEM.DISCOVER_STORAGE_TABLE_COLUMNS.[COLUMN_ID] =
        $SYSTEM.TMSCHEMA_COLUMNS.[ID]
AND $SYSTEM.TMSCHEMA_COLUMNS.[TABLE_ID] =
        $SYSTEM.TMSCHEMA_TABLES.[ID]
AND $SYSTEM.TMSCHEMA_TABLES.[IS_PRIVATE] = 0
GROUP BY
    $SYSTEM.TMSCHEMA_TABLES.[NAME],
    $SYSTEM.TMSCHEMA_COLUMNS.[NAME];
