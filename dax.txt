SELECT
    qr.query_id,
    qr.query_name,
    rs.cob_date,
    COALESCE(qes.status, 'Pending') AS status,
    COUNT(*) FILTER (WHERE rs.is_ready) AS ready_count,
    COUNT(*) FILTER (WHERE NOT rs.is_ready OR rs.is_ready IS NULL) AS pending_count,
    COUNT(*) AS total_sub_desks
FROM mr_agg_model_refresh.pbi_query_readiness qr
JOIN mr_agg_model_refresh.pbi_query_readiness_status rs
    ON qr.query_id = rs.query_id AND qr.target_node_name = rs.sub_desk_name
LEFT JOIN (
    SELECT DISTINCT ON (query_id, cob_date) query_id, cob_date, status
    FROM mr_agg_model_refresh.pbi_query_execution_status
    ORDER BY query_id, cob_date, updated_at DESC  -- or latest record
) qes
    ON qes.query_id = rs.query_id AND qes.cob_date = rs.cob_date
GROUP BY qr.query_id, qr.query_name, rs.cob_date, qes.status;
