using System;
using System.Collections.Generic;
using System.IO;
using System.Text.RegularExpressions;

class DaxInspector
{
    static void Main(string[] args)
    {
        string dax = File.ReadAllText("dax.txt"); // DAX query goes here

        var filters = ExtractFilters(dax);
        var outputColumns = ExtractSummarizeColumns(dax);

        Console.WriteLine("=== Filters ===");
        foreach (var f in filters)
        {
            Console.WriteLine($"- {f}");
        }

        Console.WriteLine("\n=== Output Columns from SUMMARIZECOLUMNS ===");
        foreach (var c in outputColumns)
        {
            Console.WriteLine($"- {c}");
        }
    }

    static HashSet<string> ExtractFilters(string dax)
    {
        var filters = new HashSet<string>();

        // Match 'Table Name'[Column] = "value" or 'value' or number
        var filterRegex = new Regex(@"('[^']+'\[\w+\])\s*=\s*(""[^""]+""|'[^']+'|\d+)", RegexOptions.IgnoreCase);
        foreach (Match match in filterRegex.Matches(dax))
        {
            filters.Add($"{match.Groups[1].Value} = {match.Groups[2].Value}");
        }

        return filters;
    }

    static HashSet<string> ExtractSummarizeColumns(string dax)
    {
        var outputCols = new HashSet<string>();

        // Match inside SUMMARIZECOLUMNS(...)
        var summarizeRegex = new Regex(@"SUMMARIZECOLUMNS\s*\((.*?)\)", RegexOptions.Singleline | RegexOptions.IgnoreCase);
        foreach (Match match in summarizeRegex.Matches(dax))
        {
            string args = match.Groups[1].Value;

            // Match 'Table Name'[Column]
            var columnRegex = new Regex(@"'[^']+'\[\w+\]", RegexOptions.IgnoreCase);
            foreach (Match col in columnRegex.Matches(args))
            {
                outputCols.Add(col.Value);
            }
        }

        return outputCols;
    }
}
